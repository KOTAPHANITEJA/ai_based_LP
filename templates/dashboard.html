{% extends 'base.html' %}
{% block content %}


<!-- Display AI Suggestions and Warnings -->
{% if messages %}
<div class="alert alert-warning">
    {% for message in messages %}
        <p>{{ message }}</p>
    {% endfor %}
</div>
{% endif %}

<h2>Available Courses</h2>
<div class="row">
    {% for course in all_courses %}
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ course.title }}</h5>
                <p>Category: {{ course.category }}</p>
                <p>Duration: {{ course.duration }} hours</p>
                <p>Difficulty: {{ course.difficulty }}</p>
                <a href="{% url 'add_to_selected' course.id %}" class="btn btn-primary">Add to Selected</a>
                <a href="{% url 'remove_course' course.id %}" class="btn btn-danger">Remove</a>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No available courses.</p>
    {% endfor %}
</div>

<h2>Selected Courses</h2>
<div class="row">
    {% for course in selected_courses %}
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ course.title }}</h5>
                <p>Category: {{ course.category }}</p>
                <p>Duration: {{ course.duration }} hours</p>
                <p>Difficulty: {{ course.difficulty }}</p>
                <a href="{% url 'add_to_recommended' course.id %}" class="btn btn-success">Recommend</a>
                <a href="{% url 'remove_from_selected' course.id %}" class="btn btn-danger">Remove</a>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No courses selected yet.</p>
    {% endfor %}
</div>

<h2>Recommended Courses</h2>
<div class="row">
    {% for course in recommended_courses %}
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ course.title }}</h5>
                <p>Category: {{ course.category }}</p>
                <p>Duration: {{ course.duration }} hours</p>
                <p>Difficulty: {{ course.difficulty }}</p>
                <a href="{% url 'remove_from_recommended' course.id %}" class="btn btn-danger">Remove</a>
                <a href="{% url 'mark_as_completed' course.id %}" class="btn btn-success">Complete</a>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No recommended courses yet.</p>
    {% endfor %}
</div>
<h2>Completed Courses</h2>
<div class="row">
    {% for course in completed_courses %}
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ course.title }}</h5>
                <p>Category: {{ course.category }}</p>
                <p>Duration: {{ course.duration }} hours</p>
                <p>Difficulty: {{ course.difficulty }}</p>
                <span class="badge bg-success">Completed</span>
                <a href="{% url 'remove_from_completed' course.id %}" class="btn btn-danger mt-2">Remove</a>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No completed courses yet.</p>
    {% endfor %}
</div>

<h3>Add a New Course</h3>
<a href="{% url 'add_course' %}" class="btn btn-primary">add a new course</a>

<h3>Your Badges üèÜ and Points üéØ</h3>
<div class="card mb-3">
  <div class="card-body">
    <h4>Points: {{ user_profile.points }}</h4>
    
    <!-- Badge Progress -->
    <div class="badge-progress mb-3">
      <h5>Badge Progress</h5>
      <div class="progress mb-2">
        <div class="progress-bar" role="progressbar" 
             style="width: {{ first_course_progress }}%"
             aria-valuenow="{{ first_course_progress }}" 
             aria-valuemin="0" aria-valuemax="100">
          First Course Badge: {{ first_course_progress }}%
        </div>
      </div>
      <div class="progress">
        <div class="progress-bar bg-success" role="progressbar" 
             style="width: {{ learning_streak_progress }}%"
             aria-valuenow="{{ learning_streak_progress }}" 
             aria-valuemin="0" aria-valuemax="100">
          Learning Streak Badge: {{ learning_streak_progress }}%
        </div>
      </div>
    </div>

    <!-- Existing Badges Section -->
    <form method="post" action="{% url 'check_badges' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary">Check Badges</button>
    </form>  
    <ul class="list-unstyled mt-3">
        {% for badge in user_profile.badges.all %}
          <li class="mb-2">
            <img src="{{ badge.get_icon_url }}" alt="{{ badge.name }}" width="30" height="30">
            <strong>{{ badge.name }}</strong> - {{ badge.description }}
          </li>
        {% empty %}
          <p>No badges earned yet.</p>
        {% endfor %}
      </ul>
  </div>
</div>

<!-- Leaderboard Section -->
<div class="card mb-3">
  <div class="card-body">
    <h3>üèÜ Leaderboard</h3>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>User</th>
            <th>Points</th>
            <th>Badges</th>
          </tr>
        </thead>
        <tbody>
          {% for profile in top_users %}
          <tr {% if profile.user == request.user %}class="table-primary"{% endif %}>
            <td>#{{ forloop.counter }}</td>
            <td>{{ profile.user.username }}</td>
            <td>{{ profile.points }}</td>
            <td>{{ profile.badges.count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Badge Earned Popup -->
<div class="modal fade" id="badgeEarnedModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üéâ New Badge Earned!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="earnedBadgeIcon" src="" alt="Badge" width="100" height="100">
        <h4 id="earnedBadgeName" class="mt-3"></h4>
        <p id="earnedBadgeDesc"></p>
      </div>
    </div>
  </div>
</div>

<!-- Add this before closing body tag -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function showBadgeEarned(badgeName, badgeDescription, badgeIcon) {
      document.getElementById('earnedBadgeName').textContent = badgeName;
      document.getElementById('earnedBadgeDesc').textContent = badgeDescription;
      document.getElementById('earnedBadgeIcon').src = badgeIcon || "/static/images/default_badge.jpg";
      new bootstrap.Modal(document.getElementById('badgeEarnedModal')).show();
    }
  
    {% if new_badge %}
      showBadgeEarned("{{ new_badge.name }}", "{{ new_badge.description }}", "{{ new_badge.get_icon_url }}");
    {% endif %}
  </script>
{% endblock %}
